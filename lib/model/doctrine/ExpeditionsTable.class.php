<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ExpeditionsTable extends Doctrine_Table
{
  public function getExpLike($name, $from_date, $to_date, $orderBy='name', $orderByOrder='asc', $start=1, $numPerPage='all')
  {
//     $orderBy = (array_key_exists($orderBy, $this->getColumns()))?$orderBy:'name';
    $q = Doctrine_Query::create()
         ->from('Expeditions e');
    if (trim($name) != ""):
      $words = explode(" ",$name);
      foreach($words as $word)
      {
        $q->andWhere("name_ts @@ search_words_to_query('expeditions' , 'name_ts', ? , 'contains') ",$word);
      }
    endif;
    if (($from_date->getMask() > 0) && ($to_date->getMask() > 0))
    {
      $q->andWhere(" e.expedition_from_date >= ? ", $from_date->format('d/m/Y'))
        ->andWhere(" e.expedition_to_date <= ? ", $to_date->format('d/m/Y'));
    }
    elseif (($from_date->getMask() > 0) && ($to_date->getMask() == 0))
    {
      $q->andWhere(" ((e.expedition_from_date >= ? AND e.expedition_from_date_mask > 0) OR (e.expedition_to_date >= ? AND e.expedition_to_date_mask > 0)) ", 
                   array($from_date->format('d/m/Y'), $from_date->format('d/m/Y'))
                  );
    } 
    elseif (($from_date->getMask() == 0) && ($to_date->getMask() > 0))
    {
      $q->andWhere(" ((e.expedition_from_date <= ? AND e.expedition_from_date_mask > 0) OR (e.expedition_to_date <= ? AND e.expedition_to_date_mask > 0)) ", 
                   array($to_date->format('d/m/Y'), $to_date->format('d/m/Y'))
                  );      
    } 

    $q->andWhere("id > 0 ")
      ->orderby($orderBy . ' ' . $orderByOrder)
      ->limit($numPerPage)
      ->offset($start);
    return $q->execute();
  }
}