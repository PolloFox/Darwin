<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class MyPreferencesTable extends Doctrine_Table
{
  public function getBoardWidgets()
  {
    $q = Doctrine_Query::create()
            ->from('MyPreferences p')
	    ->andWhere('p.user_ref = ?', sfContext::getInstance()->getUser()->getAttribute('db_user')->getId())
	    ->andWhere('p.category = ?', 'board_widget')
	    ->orderBy('p.col_num ASC, p.order_by ASC');
    return $q->execute();
  }
  
  public function changeWidgetStatus($category,$widget,$status)
  {
    $q = Doctrine_Query::create()
	->update('MyPreferences p');
	if($status == "open" || $status == "close")
    {
        $q->set('p.opened', $status=="open" ? 'true' : 'false' );
    }
    elseif($status == "visible")
    {
        $q->set('p.visible', 'true');
        $q->set('p.opened', 'true');
        $q->set('p.col_num', 1);
    }
    elseif($status == "hidden")
    {
        $q->set('p.visible', 'false');
    }
    
	$q->andWhere('p.user_ref = ?', sfContext::getInstance()->getUser()->getAttribute('db_user')->getId())
	->andWhere('p.category = ?', $category)
	->andWhere('p.group_name = ?',$widget);
    return $q->execute();
  }
  
  public static function cleanElemArray($elem)
  {
    $n_array= array();
    foreach($elem as $e)
    {
        if(preg_match('/^[A-Za-z0-9\_\-]+$/', $e))
            $n_array[] = $e;
    }
    return $n_array;
  }
  public function changeOrder($col1, $col2)
  {
    $col1 = self::cleanElemArray($col1);
    if(! empty($col1))
    {
        $sql = "update my_preferences SET
        col_num = 1,
        order_by = ( select fct_array_find('".implode(',',$col1)."',group_name::text) )
        WHERE user_ref = ".sfContext::getInstance()->getUser()->getAttribute('db_user')->getId()."
        AND category = 'board_widget'
        AND group_name in ('".implode("','",$col1)."');";
        
        $res = $this->getConnection()->getDbh()->query($sql);
    }

    if(! empty($col2))
    {
        $sql = "update my_preferences SET
        col_num = 2,
        order_by = ( select fct_array_find('".implode(',',$col2)."',group_name::text) )
        WHERE user_ref = ".sfContext::getInstance()->getUser()->getAttribute('db_user')->getId()."
        AND category = 'board_widget'
        AND group_name in ('".implode("','",$col2)."');";
        
        $res = $this->getConnection()->getDbh()->query($sql);
    }
    /*$q = Doctrine_Query::create()
	->update('MyPreferences p')
	->set('p.col_num','?',1)
	->set('p.order_by',"( select fct_array_find(p.group_name,'savedSpecimens,savedSearch') ) ")//,implode(',',$col1))
	->andWhere('p.user_ref = ?', sfContext::getInstance()->getUser()->getAttribute('db_user')->getId())
	->andWhere('p.category = ?', "board_widget") //@TODO: could be change later
	->andWhereIn('p.group_name',$col1)
    ->execute();

  $q = Doctrine_Query::create()
	->update('MyPreferences p')
	->set('p.col_num','?',2)
	->andWhere('p.user_ref = ?', sfContext::getInstance()->getUser()->getAttribute('db_user')->getId())
	->andWhere('p.category = ?', "board_widget") //@TODO: could be change later
	->andWhereIn('p.group_name',$col2)
    ->execute();*/
  }
}